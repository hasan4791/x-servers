---
- name: Create wireguard data directory
  file:
    path: "{{ xserver_data }}/x-servers-data/{{ item.name }}"
    state: directory
  with_items:
    - {name: 'wireguard'}
    - {name: 'wireguard/config'}
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Archive server files
  archive:
    path: /x-servers/wireguard
    dest: /tmp/wireguard.tgz
    format: gz
  delegate_to: 127.0.0.1
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Unarchive server files
  unarchive:
    src: /tmp/wireguard.tgz
    dest: "{{ xserver_root }}/x-servers/"
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Fetch non-root user id
  command: id -u "{{ xserver_host_non_root_user }}"
  register: user_id
  until: user_id is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Fetch non-root group id
  command: id -g "{{ xserver_host_non_root_group }}"
  register: group_id
  until: group_id is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Copy wireguard start script
  template:
    src: start.sh
    dest: "{{ xserver_root }}/x-servers/wireguard/"
    mode: 0744
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"

- name: Check root/rootless mode
  set_fact:
    wg_rootless: true
  when: xserver_rootless|bool or wg_rootless|bool

- name: Check force update
  set_fact:
    wg_force_update: true
  when: xserver_force_update|bool or wg_force_update|bool

# Rootful Mode
- name: Check image exists
  podman_image_info:
    name: "{{ xserver_wireguard }}"
  become: true
  register: image_info
  ignore_errors: true
  when: not wg_rootless|bool

- name: Build image if not exists
  command:
    cmd: ./build.sh "{{ xserver_target_arch }}" "wireguard"
    chdir: "{{ xserver_root }}/x-servers"
  become: true
  register: image_build
  until: image_build is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_info is not skipped and (image_info.images|length == 0 or wg_force_update|bool)

- name: Check container status
  containers.podman.podman_container_info:
    name: wireguard
  become: true
  register: container_status
  until: container_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: not wg_rootless|bool

- name: Stop & Remove Wireguard Server
  containers.podman.podman_container:
    name: wireguard
    state: absent
  become: true
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_build is not skipped or (not wg_rootless|bool and container_status.containers|length != 0 and not container_status.containers[0].State.Running|bool)

- name: Stop & Remove Wireguard Server
  containers.podman.podman_container:
    name: wireguard
    state: absent
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: not wg_rootless|bool

- name: Start Wireguard Server
  command:
    cmd: ./start.sh
    chdir: "{{ xserver_root }}/x-servers/wireguard"
  become: true
  environment:
    XSERVER_DATA_PATH: "{{ xserver_data }}/x-servers-data"
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_build is not skipped or (not wg_rootless|bool and not (container_status.containers|length != 0 and container_status.containers[0].State.Running|bool))

# Rootless Mode
- name: Check image exists
  podman_image_info:
    name: "{{ xserver_wireguard }}"
  register: image_info
  ignore_errors: true
  when: wg_rootless|bool

- name: Build image if not exists
  command:
    cmd: ./build.sh "{{ xserver_target_arch }}" "wireguard"
    chdir: "{{ xserver_root }}/x-servers"
  register: image_build
  until: image_build is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_info is not skipped and (image_info.images|length == 0 or wg_force_update|bool)

- name: Check container status
  containers.podman.podman_container_info:
    name: wireguard
  register: container_status
  until: container_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: wg_rootless|bool

- name: Stop & Remove Wireguard Server
  containers.podman.podman_container:
    name: wireguard
    state: absent
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_build is not skipped or (wg_rootless|bool and container_status.containers|length != 0 and not container_status.containers[0].State.Running|bool)

- name: Stop & Remove Wireguard Server
  containers.podman.podman_container:
    name: wireguard
    state: absent
  become: true
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: wg_rootless|bool

- name: Fetch podman non-root user id
  command: id -u
  register: podman_user_id
  until: user_id is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: wg_rootless|bool

- name: Fetch podman non-root group id
  command: id -g
  register: podman_group_id
  until: group_id is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: wg_rootless|bool

- name: Change data directory ownership
  file:
    path: "{{ xserver_data }}/x-servers-data/wireguard/config"
    owner: "{{ podman_user_id.stdout }}"
    group: "{{ podman_group_id.stdout }}"
    recurse: true
    state: directory
  become: true
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: wg_rootless|bool

- name: Start Wireguard Server
  command:
    cmd: ./start.sh
    chdir: "{{ xserver_root }}/x-servers/wireguard"
  environment:
    XSERVER_DATA_PATH: "{{ xserver_data }}/x-servers-data"
  register: task_status
  until: task_status is successful
  retries: "{{ task_retries | int }}"
  delay: "{{ task_delay | int }}"
  when: image_build is not skipped or (wg_rootless|bool and not (container_status.containers|length != 0 and container_status.containers[0].State.Running|bool))
